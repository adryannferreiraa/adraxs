<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="PORTAL__2_-removebg-preview-_1_.ico" type="image/x-icon">
    <link rel="stylesheet" href="portal.css">
    <title>Adraxs</title>
</head>
<body>
    <header>
        Adraxs
    </header>

    <div class="container">
        <form method="POST" onsubmit="postar(); return false">
            <textarea placeholder="O que você está pensando?" id="mensagem" required></textarea>
            <input type="submit" value="Postar">
        </form>

        <div id="feed"></div>

        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

        <script>
            var nomeDeLogin = localStorage.getItem('nomeDeLogin');

            async function exibirPosts() {
                var feedContainer = document.getElementById("feed");
                feedContainer.innerHTML = "";

                const postsCollection = firebase.firestore().collection('posts');
                const postsSnapshot = await postsCollection.get();

                postsSnapshot.forEach((post) => {
                    var postElement = document.createElement("div");
                    postElement.className = "post";

                    var interacoesElement = document.createElement("div");
                    interacoesElement.className = "interacoes";
                    interacoesElement.innerHTML = `
                        <span class="interacao" onclick="curtir('${post.id}', '${post.data().likes}')">Curtir</span>
                        <span class="likes">${post.data().likes} Likes</span>
                        <div class="post-options">
                            ${post.data().usuario === nomeDeLogin ? `<button onclick="editarPost('${post.id}', '${post.data().mensagem}')">Editar</button>` : ''}
                            ${post.data().usuario === nomeDeLogin ? `<button onclick="excluirPost('${post.id}')">Excluir</button>` : ''}
                        </div>
                    `;

                    postElement.innerHTML = `
                        <p class="usuario">@${post.data().usuario}</p>
                        <p class="mensagem">${post.data().mensagem}</p>
                    `;

                    postElement.appendChild(interacoesElement);
                    feedContainer.appendChild(postElement);
                });
            }

            async function postar() {
                var mensagem = document.getElementById('mensagem').value;

                const postsCollection = firebase.firestore().collection('posts');
                await postsCollection.add({
                    usuario: nomeDeLogin || "Convidado",
                    mensagem: mensagem,
                    likes: 0,
                });

                // Limpar o campo de mensagem após postar
                document.getElementById('mensagem').value = '';

                exibirPosts();
            }

            async function curtir(postId, likes) {
                likes = parseInt(likes) + 1;

                const postsCollection = firebase.firestore().collection('posts');
                const postDoc = postsCollection.doc(postId);

                await postDoc.update({
                    likes: likes,
                });

                exibirPosts();
            }

            async function editarPost(postId, mensagemAtual) {
                var novoTexto = prompt('Digite o novo texto para o post:', mensagemAtual);
                if (novoTexto !== null) {
                    const postsCollection = firebase.firestore().collection('posts');
                    const postDoc = postsCollection.doc(postId);

                    await postDoc.update({
                        mensagem: novoTexto,
                    });

                    exibirPosts();
                }
            }

            async function excluirPost(postId) {
                var confirmacao = confirm('Deseja realmente excluir este post?');
                if (confirmacao) {
                    const postsCollection = firebase.firestore().collection('posts');
                    const postDoc = postsCollection.doc(postId);

                    await postDoc.update({
                        excluido: true,
                    });

                    exibirPosts();
                }
            }

            window.onload = exibirPosts;
        </script>
    </div>
</body>
</html>
